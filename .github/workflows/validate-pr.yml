name: 插件 PR 自动审核

on:
  pull_request:
    branches: [main]
    paths:
      - 'plugins.v4.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: 校验插件索引
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout base branch for diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate plugins.v4.json (with diff)
        id: validate
        run: |
          node scripts/validate-plugin.mjs --diff origin/${{ github.base_ref }} 2>&1 | tee validation-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Generate PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('validation-output.txt', 'utf-8');

            // 清理 ANSI 颜色码
            const clean = output.replace(/\x1b\[[0-9;]*m/g, '');

            const exitCode = '${{ steps.validate.outputs.exit_code }}';
            const passed = exitCode === '0';

            const icon = passed ? '✅' : '❌';
            const title = passed ? '插件校验通过' : '插件校验未通过';

            const body = `## ${icon} ${title}

            <details>
            <summary>校验详情（点击展开）</summary>

            \`\`\`
            ${clean}
            \`\`\`

            </details>

            ${!passed ? `
            > **请修复上述错误后重新提交。** 常见问题：
            > - 插件 ID 必须符合 \`napcat-plugin-xxx\` 格式
            > - 所有必填字段不能为空
            > - downloadUrl 必须是可访问的 .zip 链接
            > - 版本号需符合 semver 格式
            ` : '> 所有检查已通过，等待维护者审核合并。'}
            `;

            // 查找已有的 bot 评论
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('插件校验')
            );

            const commentBody = body.split('\n').map(l => l.trim()).join('\n');

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

      - name: Fail if validation failed
        if: steps.validate.outputs.exit_code != '0'
        run: exit 1

  auto-label:
    name: 自动打标签
    runs-on: ubuntu-latest
    needs: validate
    if: success()
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect change type and label
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // 获取 diff
            execSync(`git fetch origin ${{ github.base_ref }} --depth=1`);

            let baseContent, currentContent;
            try {
              baseContent = JSON.parse(execSync(`git show origin/${{ github.base_ref }}:plugins.v4.json`, { encoding: 'utf-8' }));
              currentContent = JSON.parse(require('fs').readFileSync('plugins.v4.json', 'utf-8'));
            } catch {
              return;
            }

            const baseIds = new Set(baseContent.plugins.map(p => p.id));
            const currentIds = new Set(currentContent.plugins.map(p => p.id));

            const labels = [];

            // 新增插件
            for (const p of currentContent.plugins) {
              if (!baseIds.has(p.id)) labels.push('新插件');
            }

            // 更新插件
            for (const p of currentContent.plugins) {
              if (baseIds.has(p.id)) {
                const base = baseContent.plugins.find(b => b.id === p.id);
                if (JSON.stringify(base) !== JSON.stringify(p)) {
                  labels.push('插件更新');
                }
              }
            }

            // 删除插件
            for (const id of baseIds) {
              if (!currentIds.has(id)) labels.push('插件删除');
            }

            const uniqueLabels = [...new Set(labels)];
            if (uniqueLabels.length > 0) {
              // 确保标签存在
              for (const label of uniqueLabels) {
                try {
                  await github.rest.issues.getLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                  });
                } catch {
                  const colors = { '新插件': '0e8a16', '插件更新': '1d76db', '插件删除': 'e11d48' };
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: colors[label] || 'ededed',
                  });
                }
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: uniqueLabels,
              });
            }
