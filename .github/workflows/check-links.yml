name: æ’ä»¶é“¾æ¥å®šæ—¶å·¡æ£€

on:
  schedule:
    # æ¯å¤© UTC 04:00ï¼ˆåŒ—äº¬æ—¶é—´ 12:00ï¼‰æ‰§è¡Œ
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-links:
    name: æ£€æŸ¥æ‰€æœ‰æ’ä»¶ä¸‹è½½é“¾æ¥
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check all plugin links
        id: check
        run: |
          node scripts/validate-plugin.mjs --check-links 2>&1 | tee check-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Report broken links via Issue
        if: steps.check.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('check-output.txt', 'utf-8');
            const clean = output.replace(/\x1b\[[0-9;]*m/g, '');

            // æå–å¤±è´¥çš„é“¾æ¥
            const errorLines = clean.split('\n').filter(l => l.includes('âœ—') || l.includes('ä¸å¯è¾¾'));

            const today = new Date().toISOString().split('T')[0];
            const title = `ğŸ”— æ’ä»¶é“¾æ¥å·¡æ£€æŠ¥å‘Š - ${today}`;

            const body = `## ğŸ”— æ’ä»¶é“¾æ¥å·¡æ£€æŠ¥å‘Š

            **æ£€æŸ¥æ—¶é—´**: ${new Date().toISOString()}

            ### âŒ å‘ç°é—®é¢˜çš„é“¾æ¥

            \`\`\`
            ${errorLines.join('\n') || 'æ— '}
            \`\`\`

            ### ğŸ“‹ å®Œæ•´æ—¥å¿—

            <details>
            <summary>ç‚¹å‡»å±•å¼€</summary>

            \`\`\`
            ${clean}
            \`\`\`

            </details>

            ---
            > æ­¤ Issue ç”± CI è‡ªåŠ¨åˆ›å»ºã€‚è¯·ç›¸å…³æ’ä»¶ä½œè€…æ£€æŸ¥ä¸‹è½½é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚
            `;

            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ä»Šå¤©çš„å·¡æ£€ issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'é“¾æ¥å·¡æ£€',
              per_page: 5,
            });

            const existingIssue = issues.find(i => i.title.includes(today));

            const cleanBody = body.split('\n').map(l => l.trim()).join('\n');

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: cleanBody,
              });
            } else {
              // ç¡®ä¿æ ‡ç­¾å­˜åœ¨
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'é“¾æ¥å·¡æ£€',
                });
              } catch {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'é“¾æ¥å·¡æ£€',
                  color: 'f9a825',
                });
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: cleanBody,
                labels: ['é“¾æ¥å·¡æ£€'],
              });
            }

      - name: Close old check issues if all links OK
        if: steps.check.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'é“¾æ¥å·¡æ£€',
              per_page: 10,
            });

            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… æ‰€æœ‰æ’ä»¶é“¾æ¥å·²æ¢å¤æ­£å¸¸ï¼Œè‡ªåŠ¨å…³é—­æ­¤ Issueã€‚',
              });
            }
